<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/statistics.css') }}">
    <script defer src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
</head>
<body>
<div class="theme-toggle">
    <button id="toggle-theme">üåô</button>
</div>

<div class="stats-page">
    <div class="bg-orbit bg-orbit-1"></div>
    <div class="bg-orbit bg-orbit-2"></div>

    <header class="stats-topbar">
        {% if is_admin %}
            <a href="{{ url_for('dashboard') }}" class="top-back">
                ‚Üê –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
            </a>
        {% else %}
            <a href="{{ url_for('index') }}" class="top-back">
                ‚Üê –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            </a>
        {% endif %}

        <div class="top-brand">
            <div class="brand-mark">54</div>
            <div class="brand-text">
                <span class="brand-label">54TrafficInsight</span>
                <span class="brand-sub">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞</span>
            </div>
        </div>
    </header>

    <main class="stats-layout">
        <section class="stats-main-card">
            <div class="stats-main-header">
                <div>
                    <p class="eyebrow">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Ä¢ –ü—Ä–∏–≥–æ—Ä–æ–¥–Ω–æ–µ ‚Ä¢ –î–∞–ª—å–Ω–µ–µ</p>
                    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞</h1>
                    <p class="subtitle">
                        –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥ (2016‚Äì2024), —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞
                        –ø–æ –º–µ—Å—è—Ü–∞–º.
                    </p>
                </div>
                <div class="year-chip">
                    <span>–¢–µ–∫—É—â–∏–π –≥–æ–¥ –≤—ã–±–æ—Ä–∫–∏</span>
                    <strong>{{ selected_year or 2024 }}</strong>
                </div>
            </div>

            <form method="post" class="year-form">
                <div class="year-form-inner">
                    <div class="year-field">
                        <label for="year">–ì–æ–¥</label>
                        <input
                            type="number"
                            id="year"
                            name="year"
                            min="2016"
                            max="2024"
                            required
                            value="{{ selected_year or 2024 }}"
                        >
                    </div>
                    <button type="submit" class="btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                </div>
            </form>

            {% if rows %}
                {% set total_passengers = rows|sum(attribute='total') %}
                {% set months_with_incidents = rows|selectattr('has_incident')|list|length %}

                <div class="chips-row">
                    <div class="chip">
                        <span class="chip-label">–í—Å–µ–≥–æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∑–∞ –≥–æ–¥</span>
                        <span class="chip-value">
                            {{ "{:,.0f}".format(total_passengers).replace(",", " ") }}
                        </span>
                    </div>
                </div>

                <div class="legend-row">
                    <div class="legend-item">
                        <span class="legend-pill legend-pill-suburban"></span>
                        <span>–ü—Ä–∏–≥–æ—Ä–æ–¥–Ω–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</span>
                        <span class="legend-pill legend-pill-long"></span>
                        <span>–î–∞–ª—å–Ω–µ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</span>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>–ú–µ—Å—è—Ü</th>
                                <th>–ü—Ä–∏–≥–æ—Ä–æ–¥–Ω–æ–µ</th>
                                <th>–î–∞–ª—å–Ω–µ–µ</th>
                                <th>–í—Å–µ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for row in rows %}
                            <tr class="row-body {% if row.has_incident %}has-incident{% endif %}">
                                <td class="month-cell">
                                    <span class="month-name">{{ row.month_name }}</span>
                                    <span class="month-index">{{ "%02d"|format(row.month) }}</span>
                                </td>
                                <td class="num suburban">
                                    {{ "{:,.0f}".format(row.suburban).replace(",", " ") }}
                                </td>
                                <td class="num long-distance">
                                    {{ "{:,.0f}".format(row.long_distance).replace(",", " ") }}
                                </td>
                                <td class="num total">
                                    {{ "{:,.0f}".format(row.total).replace(",", " ") }}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="empty-hint">
                    –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ
                    <strong>¬´–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É¬ª</strong>.
                </p>
            {% endif %}
        </section>

        <aside class="stats-side-card">
            <div class="side-glow"></div>
            <h2>–°—Ä–µ–∑ –ø–æ –≥–æ–¥—É</h2>
            <p class="side-desc">
                –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ–¥–∞ —Å —É–ø–æ—Ä–æ–º –Ω–∞ –ø–µ—Ä–∏–æ–¥—ã,
                –≥–¥–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã –º–æ–≥–ª–∏ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫.
            </p>

            <div class="side-metrics">
                {% if rows %}
                    {% set total_passengers = rows|sum(attribute='total') %}
                    {% set months_with_incidents = rows|selectattr('has_incident')|list|length %}
                    {% set avg_per_month = (total_passengers / 12) if rows else 0 %}
                    <div class="side-metric">
                        <span class="metric-label">–°—Ä–µ–¥–Ω–∏–π –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫ –≤ –º–µ—Å—è—Ü</span>
                        <span class="metric-value">
                            {{ "{:,.0f}".format(avg_per_month).replace(",", " ") }}
                        </span>
                    </div>
                {% else %}
                    <div class="side-metric">
                        <span class="metric-label">–°–æ–≤–µ—Ç</span>
                        <span class="metric-value">
                            –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
                        </span>
                    </div>
                {% endif %}
            </div>

            <div class="side-footer">
                <p class="side-footer-title">–†–µ–∂–∏–º—ã –¥–æ—Å—Ç—É–ø–∞</p>
                <p class="side-footer-text">
                    –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ—Ç—Ä—è—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø—Ä–æ–≥–Ω–æ–∑.
                    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è—é—Ç –¥–∞–Ω–Ω—ã–º–∏ –∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º–∏.
                </p>
            </div>
        </aside>
    </main>
</div>
</body>
</html>
