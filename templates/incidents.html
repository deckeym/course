<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã –Ω–∞ –∂–µ–ª–µ–∑–Ω–æ–π –¥–æ—Ä–æ–≥–µ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/incidents.css') }}">
  <script defer src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
  <script>
    function updateDescCounter() {
      const el = document.getElementById('description');
      const counter = document.getElementById('descCounter');
      if (el && counter) {
        counter.textContent = (el.value || '').length + '/255';
      }
    }
    document.addEventListener('DOMContentLoaded', updateDescCounter);
  </script>
</head>
<body>
<div class="theme-toggle">
  <button id="toggle-theme">üåô</button>
</div>

<div class="incidents-page">
  <div class="bg-orbit bg-orbit-1"></div>
  <div class="bg-orbit bg-orbit-2"></div>

  <header class="inc-topbar">
    <a href="{{ url_for('dashboard') }}" class="top-back">‚Üê –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>

    <div class="top-brand">
      <div class="brand-mark">54</div>
      <div class="brand-text">
        <span class="brand-label">54TrafficInsight</span>
        <span class="brand-sub">–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã –Ω–∞ –ñ–î</span>
      </div>
    </div>
  </header>

  <main class="inc-layout">
    <section class="inc-main-card">
      <div class="inc-header">
        <p class="eyebrow">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Ä¢ –†–∏—Å–∫–∏ ‚Ä¢ –í–ª–∏—è–Ω–∏–µ</p>
        <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –Ω–∞ –∂–µ–ª–µ–∑–Ω–æ–π –¥–æ—Ä–æ–≥–µ</h1>
        <p class="subtitle">
          –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è –Ω–∞ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è (2026‚Äì2030 –≥–æ–¥—ã).
          –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –∏ –ø—Ä–æ–≥–Ω–æ–∑–µ.
        </p>
      </div>

      {% with messages = get_flashed_messages(with_categories=true, category_filter=['inc_success','inc_warning','inc_danger']) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form method="POST" autocomplete="off" class="inc-form">
        <div class="field-grid">
          <div class="field">
            <label for="year">–ì–æ–¥ <span class="hint-label">(2026‚Äì2030)</span></label>
            <input id="year"
                   type="number"
                   name="year"
                   min="2026"
                   max="2030"
                   required
                   value="{{ request.form.get('year','') }}">
          </div>

          <div class="field">
            <label for="month">–ú–µ—Å—è—Ü</label>
            <input id="month"
                   type="number"
                   name="month"
                   min="1"
                   max="12"
                   required
                   value="{{ request.form.get('month','') }}">
          </div>

          <div class="field">
            <label for="duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –º–µ—Å.</label>
            <input id="duration"
                   type="number"
                   name="duration"
                   min="1"
                   max="12"
                   required
                   value="{{ request.form.get('duration','') }}">
          </div>

          <div class="field">
            <label for="impact">
              –í–ª–∏—è–Ω–∏–µ, %
              <span class="hint-label">(‚àí100‚Ä¶100)</span>
            </label>
            <input id="impact"
                   type="number"
                   name="impact"
                   step="0.01"
                   min="-1"
                   max="1"
                   required
                   placeholder="-0.20"
                   title="–î–∏–∞–ø–∞–∑–æ–Ω: –æ—Ç -1.00 –¥–æ 1.00 (‚àí0.20 = ‚àí20%)"
                   value="{{ request.form.get('impact','') }}">
          </div>
        </div>

        <div class="field field-full">
          <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞</label>
          <textarea id="description"
                    name="description"
                    maxlength="255"
                    oninput="updateDescCounter()"
                    rows="3"
                    placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ, –µ–≥–æ –ø—Ä–∏—á–∏–Ω—É –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è...">{{ request.form.get('description','') }}</textarea>
          <div class="hint-row">
            <small class="hint-text">–î–æ 255 —Å–∏–º–≤–æ–ª–æ–≤</small>
            <small id="descCounter" class="hint-counter">0/255</small>
          </div>
        </div>

        <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç</button>
      </form>
    </section>

    <aside class="inc-side-card">
      <div class="side-glow"></div>

      <h2>–õ–µ–Ω—Ç–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤</h2>
      <p class="side-subtitle">
        –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞.
        –ß–µ–º —Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è–Ω–∏–µ –∏ –¥–æ–ª—å—à–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ç–µ–º –∑–∞–º–µ—Ç–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ.
      </p>

      {% if incidents and incidents|length > 0 %}
        <ul class="incident-list">
          {% for inc in incidents %}
          <li class="incident-item">
            <div class="inc-headline">
              <span class="pill-date">
                {{ inc.year }}-{{ '%02d'|format(inc.month) }}
              </span>
              <span class="pill-duration">
                {{ inc.duration }} –º–µ—Å
              </span>
              {% set pct = (inc.impact * 100) %}
              <span class="pill-impact {% if pct < 0 %}negative{% elif pct > 0 %}positive{% else %}neutral{% endif %}">
                {% if pct > 0 %}+{% endif %}{{ pct | round(1) }}%
              </span>
            </div>
            <p class="inc-desc">
              {{ inc.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}
            </p>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="empty-incidents">–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –Ω–∞ –∂–µ–ª–µ–∑–Ω–æ–π –¥–æ—Ä–æ–≥–µ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
      {% endif %}
    </aside>
  </main>
</div>
</body>
</html>
